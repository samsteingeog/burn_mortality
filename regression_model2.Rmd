---
title: "regression_model2"
author: "Samantha Hing"
date: "4/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(caTools)
library(caret)
library(MASS)
library(glmnet)

```

### Run these files first
```{r}
# Run these files to get data frames
# Maybe we should turn them into .R files instead?
rmarkdown::render('./ClimateStations_RAWS.Rmd') # gives us weather dataframe ("fires_weather")
rmarkdown::render('./FireDBR_calcs.Rmd') # gives us dbr dataframe ("dbr_data")

```

## Join data sources

```{r read data}
# read in average data csv file
# gives us elevation, slope, aspect averages for whole fire
average_data <- read_csv("data/avg_std.csv")

# No longer needed - delete later
# #import Yiyi's file with data from 10k sample points
# sample_pts <- read_csv("data/sample_pts")
# 
# #clean up date values
# sample_pts$ALARM_DATE <- ymd_hms(sample_pts$ALARM_DATE) #change from char to date
# sample_pts$CONT_DATE <- ymd_hms(sample_pts$CONT_DATE)
# #sample_pts$duration <- as.numeric(sample_pts$duration) #couldn't figure out how to extract just first digits of string (maybe a regex?)
# sample_pts$fireduration <- interval(sample_pts$ALARM_DATE, sample_pts$CONT_DATE) %>% #coerce duration dates into time values
#   as.duration()
```

```{r make final tables}
# join all the datasets (averages, weather, dbr)
all_data <- full_join(average_data, fires_weather, by = "OBJECTID")
all_data <- full_join(all_data, dbr_data, by = "OBJECTID") %>%
  dplyr::select(-YEAR_, -STATE) #drop extraneous variables

# make exportable version
 all_df <- all_data %>%
   dplyr::select(-geometry)

# write.csv(all_df, file = "all_data.csv")

#drop missing values for DEM and derived data
#drop values without info on dbr
all_df <- all_df %>%  
  filter(!is.na(DEM_MEAN)) %>%
  filter(!is.na(dbr_means))

# No longer needed - delete later
# #clean up date values
# sample_pts$ALARM_DATE <- ymd_hms(sample_pts$ALARM_DATE) #change from char to date
# sample_pts$CONT_DATE <- ymd_hms(sample_pts$CONT_DATE)
# #sample_pts$duration <- as.numeric(sample_pts$duration) #couldn't figure out how to extract just first digits of string (maybe a regex?)
# sample_pts$fireduration <- interval(sample_pts$ALARM_DATE, sample_pts$CONT_DATE) %>% #coerce duration dates into time values
#   as.duration()

# add fire duration to dataframe
all_df <- all_df %>%
  mutate(fireduration = as.duration(interval(ALARM_DATE, CONT_DATE))) %>%
# add in 12 hours of fireduration for fires that started and ended the same day
  mutate(fireduration = replace(fireduration, fireduration== as.duration(0), as.duration(43200))) %>%
  mutate(fireduration = as.numeric(fireduration)) # change to numeric
```


```{r data splitting}

# Test/Train split(s)
 set.seed(1)
 
 data_split = sample.split(all_df, SplitRatio = 0.75) #setting up testing and training split
 train <- subset(all_df, data_split == TRUE)
 test <-subset(all_df, data_split == FALSE)

#seperating into ind and dep variables for later 
 
all_dbr <- all_df$dbr_means #just dependent variables
test_dbr <- test$dbr_means
train_dbr <- train$dbr_means
#summ_dbr <- summ_df$dbr_means

all_ind <- all_df %>% #just independent variables
  dplyr::select(slope_MEAN, aspect_MEAN, DEM_MEAN, LiveBio_MEAN, DeadBio_MEAN, fireduration, GIS_ACRES, 
          month_temp, week_temp, month_precip, week_precip, wind_speed, month_humid, week_humid)
test_ind <- test %>% #just independent variables
  dplyr::select(slope_MEAN, aspect_MEAN, DEM_MEAN, LiveBio_MEAN, DeadBio_MEAN, fireduration, GIS_ACRES, 
          month_temp, week_temp, month_precip, week_precip, wind_speed, month_humid, week_humid)
train_ind <- train %>% #just independent variables
  dplyr::select(slope_MEAN, aspect_MEAN, DEM_MEAN, LiveBio_MEAN, DeadBio_MEAN, fireduration, GIS_ACRES, 
          month_temp, week_temp, month_precip, week_precip, wind_speed, month_humid, week_humid)
# summ_ind <- summ_df %>% #just independent variables
#   dplyr::select(slope_MEAN, aspect_MEAN, DEM_MEAN, LiveBio_MEAN, DeadBio_MEAN, fireduration, GIS_ACRES, 
#           month_temp, week_temp, month_precip, week_precip, wind_speed, month_humid, week_humid)
 
 
```

## Set up OLS model

```{r OLS}

#create the model (using all data for now)
#current model doesn't include precip/temp/humid during the fire or solar radiation data
ols1 <- lm(dbr_means ~ slope_MEAN + aspect_MEAN + DEM_MEAN + LiveBio_MEAN + DeadBio_MEAN + fireduration + GIS_ACRES + 
          month_temp + week_temp + month_precip + week_precip + wind_speed + month_humid + week_humid, 
          data = all_df)

#summary(ols)

#Check fit 
all_df$pred_dbr <- predict(ols1, newdata = all_df)

ggplot(all_df) +
  geom_point(aes(x = dbr_means, y = pred_dbr), alpha = 0.4) +
  xlim(0,1000) +
  ylim(0,1000) +
  theme_minimal()

#Fit is pretty bad so far (tendancy to dramatically underestimate dbr)
# 
# #using data average across all fires
# ols2 <- lm(dbr ~ slope_MEAN + aspect_MEAN + DEM_MEAN + LiveBio_MEAN + DeadBio_MEAN + fireduration + GIS_ACRES + 
#           month_temp + week_temp + month_precip + week_precip + wind_speed + month_humid + week_humid, 
#           data = summ_df)
# 
# summ_df$pred_dbr <- predict(ols2, newdata = summ_df)
# 
# ggplot(summ_df) +
#   geom_point(aes(x = dbr_means, y = pred_dbr), alpha = 0.4) +
#   geom_abline(slope = 1) +
#   xlim(0,1000) +
#   ylim(0,1000) +
#   theme_minimal()

```

```{r OLS stepwise}
#trying a stepwise function to select only most relevant variables

control <- trainControl(method = "repeatedcv", number = 10, selectionFunction = "best") #this controls the settings for the model selection (10-fold cross validation currently)

all_step <- train(x = all_ind, 
                  y = all_dbr, 
                  form = ols1, 
                  data = all_df,
                  method = "leapSeq", #stepwise version of function
                  tuneGrid = data.frame(nvmax = 1:14),
                  trControl = control) #using settings from above

#summary(all_step)

#Using a stepwise model selector based on AIC 
#Input is the linear model (w/ all parameters) derived above 
#k - degrees of freedom for penalty (2 for true AIC); direction - both (try adding and substracting terms)
AIC_ols <- stepAIC(ols1, direction = "both", k = 2)

extractAIC(AIC_ols) #Stepwise dropped month_precip and fire duration based on fit; not sure if we should trust this??

summary(AIC_ols)

all_df$step_dbr <- predict(AIC_ols, newdata = all_df) #predict using pared down model

ggplot(all_df) + #doesn't seem to make much difference
  geom_point(aes(x = dbr_means, y = step_dbr), alpha = 0.4) +
  geom_abline(slope = 1) +
  xlim(0,1000) +
  ylim(0,1000) +
  theme_minimal()

# #Using averaged data for step_AIC
# AIC_ols2 <- stepAIC(ols2, direction = "both", k = 2)
# 
# extractAIC(AIC_ols2) #Stepwise dropped month_precip and fire duration based on fit; not sure if we should trust this??
# 
# summary(AIC_ols2)
# 
# summ_df$step_dbr <- predict(AIC_ols2, newdata = summ_df) #predict using pared down model
# 
# ggplot(summ_df) + #doesn't seem to make much difference
#   geom_point(aes(x = dbr_means, y = step_dbr), alpha = 0.4) +
#   geom_abline(slope = 1) +
#   xlim(0,1000) +
#   ylim(0,1000) +
#   theme_minimal()


```

```{r LASSO}
#trying LASSO

#all data points
all_x <- as.matrix(all_ind)
all_y <- as.matrix(all_dbr)

all_lasso <- cv.glmnet(x = all_x, y = all_y, 
                           family = "gaussian", standardize = TRUE, 
                           intercept = TRUE, alpha = 1)
all_df$lasso_dbr <- predict(all_lasso, newx= all_x) 

ggplot(all_df) + #doesn't seem to make much difference
  geom_point(aes(x = dbr_means, y = lasso_dbr), alpha = 0.4) +
  geom_abline(slope = 1) +
  xlim(0,1000) +
  ylim(0,1000) +
  theme_minimal()

# #using fire-wide averages
# 
# summ_x <- as.matrix(summ_ind)
# summ_y <- as.matrix(summ_dbr)
# 
# summ_lasso <- cv.glmnet(x = summ_x, y = summ_y, 
#                            family = "gaussian", standardize = TRUE, 
#                            intercept = TRUE, alpha = 1)
# summ_df$lasso_dbr <- predict(summ_lasso, newx= summ_x) 
# 
# ggplot(summ_df) + #doesn't seem to make much difference
#   geom_point(aes(x = dbr_means, y = lasso_dbr), alpha = 0.4) +
#   geom_abline(slope = 1) +
#   xlim(0,1000) +
#   ylim(0,1000) +
#   theme_minimal()

```


