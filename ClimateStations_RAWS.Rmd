---
title: "Untitled"
author: "Samantha Hing"
date: "4/15/2020"
output: html_document
---
#### Load packages
```{r}
library(readr)
library(dplyr)
library(tidyr)
library(sf)
library(sp)
library(rnaturalearth)
library(ggplot2)
library(rgdal)
library(nngeo)

```

#### Read in data
```{r}
# read in stations data
stations <- read.fwf("data/RAWS.txt", widths = c(28, 14, 8, 4, 2, 4, 6, 2, 2), 
         col.names = c("station", "state", "elevation", "lat_dd","lat_mm","lat_ss","long_dd", "long_mm", "long_ss"), skip = 3, colClasses = c("character", "character", "integer", "integer", "integer", "integer", "integer", "integer", "integer"), stringsAsFactors = FALSE, nrow = 493)

# stations <- stations %>%
#   separate(latitude, into = c('lat_dd', 'lat_mm', 'lat_ss'), sep = c(2, 4)) %>%
#   mutate(ns = rep('W', nrow(stations))) 

stations <- stations %>% mutate(ns_long = rep('W', nrow(stations)), ns_lat = rep('N', nrow(stations)))

stations <- stations %>% 
  mutate(latitude =  biogeo::dms2dd(lat_dd, lat_mm, lat_ss, ns_lat), 
         longitude =  biogeo::dms2dd(long_dd, long_mm, long_ss, ns_long))

# read in fire data
fires <- read_sf(dsn = "./data/fire_data", layer = "110fires_sample")
#plot(fires)
```

### Plot stations
```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")

max_lat <- max(stations$latitude)
min_lat <- min(stations$latitude)
max_long <- max(stations$longitude)
min_long <- min(stations$longitude)

ggplot(data = world) +
    geom_sf() +
    geom_point(data = stations, aes(x = longitude, y = latitude), size = 4, 
        shape = 23, fill = "darkred") +
    coord_sf(xlim = c(min_long, max_long), ylim = c(min_lat, max_lat), expand = FALSE)
```

### Convert data
```{r converting data}
#convert data for next step
#making spatial files to try with rgeos
stations_sp <- stations
coordinates(stations_sp)=~longitude+latitude
proj4string(stations_sp)<- CRS("+proj=longlat +ellps=WGS84") #guessing at original data's projection

stations_sp <-spTransform(stations_sp, CRS="+proj=utm +zone=10 +datum=NAD83") #change to UTM to match fire data

fires_sp <- as(fires, "Spatial")

#making sf files to try with sf
stations_sf <- st_as_sf(stations_sp)
stations_sf <- st_transform(stations_sf, crs = st_crs(fires)) #set crs to match fire data

#st_write(stations_sf, dsn = "./data/stations_v10.shp", layer = "stations_v10.shp")
```


### Find nearest station to each fire

```{r nearest}
#trying using rgeos FAILED
# nearest <- gNearestPoints(fires_sp[1], station_try)
# plot(nearest) #only returns one pair of points

#trying using sf
fire_centers <- st_centroid(fires, of_largest_polygon = FALSE) #creating points for centroid of fires

#table of just station names by index number
station_names <- data.frame(stations$station) %>%
  mutate(station_index = 1:490)

#find 3 closest stations
backups <- st_nn(fire_centers, stations_sf, k = 3) #modified to select three closest neighbors
stn_backups <- data.frame(matrix(unlist(backups), ncol = max(lengths(backups)), byrow = TRUE)) #get into df

#join data
fires_wstns <- fires %>%   #attach index number of each station to fire data
  mutate(station1 = stn_backups$X1) %>%
  mutate(station2 = stn_backups$X2) %>%
  mutate(station3 = stn_backups$X3)
 
fires_wstns <- left_join(fires_wstns, station_names, by = c("station1" = "station_index")) %>%
  rename(stn_1 = stations.station)
  
fires_wstns <- left_join(fires_wstns, station_names, by = c("station2" = "station_index")) %>%
  rename(stn_2 = stations.station)

fires_wstns <- left_join(fires_wstns, station_names, by = c("station3" = "station_index")) %>%
  rename(stn_3 = stations.station) %>%
  select(-station1, -station2, -station3)

#st_write(fires_wstns, dsn = "./data/fire_data/fires_wstns.shp", layer = "fires_wstns.shp")

```

