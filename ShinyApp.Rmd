---
title: "ShinyApp"
author: "Samantha Hing"
date: "4/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load packages
library(leaflet)
library(shiny)
library(shinythemes)
library(tidyverse)
library(raster)

```

### Run these files first
```{r}
# Run these files to get data frames
# Maybe we should turn them into .R files instead?
# rmarkdown::render('./ClimateStations_RAWS.Rmd') # gives us weather dataframe ("fires_weather")
# rmarkdown::render('./FireDBR_calcs.Rmd') # gives us dbr dataframe ("dbr_data")
rmarkdown::render('./dead&liveBiomass.Rmd') # gives us list of dead & live biomass rasters ("live_biomassList" & "dead_biomassList")
rmarkdown::render('./regression_model2.Rmd') # gives us dataframes: fires_weather, ave_data, dbr_data

# name rasters by ObjectID
names(rasterList) <- OBJECTID 

#average_data <- read_csv("data/ave_export_sum.csv") # gives average data





```
# data prep
```{r}
# get centroid of fires
fires <- fires %>%
  mutate(centroids = st_centroid(geometry))
fires_points <- fires$centroids
fires_points <- st_transform(fires_points, 4326)
x <- as.data.frame(st_coordinates(fires_points))
x <- x %>% mutate(OBJECTID = as.character(fires$OBJECTID))
```

# User Interface
```{r}
ui <- fluidPage (
  navbarPage("DS421 Project",
  #titlePanel("California Wildfires 2017"), #make better title later
  theme = shinythemes::shinytheme('simplex'),
  tabPanel("About"),
  
      
  tabPanel("Fire Data",
      # selectInput('results', 'Pick Results to See', choices = c('DBR', 'dead biomass', 'live biomass')),
    sidebarPanel(
      leaflet::leafletOutput('dbr_map'), # dbr map
      leaflet::leafletOutput('livebiomass_map'), # live biomass map
      leaflet::leafletOutput('deadbiomass_map')
    ),
    mainPanel(
      leaflet::leafletOutput('map', width = '100%'),  # add CA map
      DT::DTOutput(outputId = "table") # weather table
    )
  ),
  tabPanel("Model Results")
  )
  )

```

# Server
```{r}
server <- function(input, output, session) {
 
  # create map of California with a marker for each fire
  output$map <- leaflet::renderLeaflet({
    leaflet(
      options = leafletOptions(zoomControl = FALSE,
                     dragging = FALSE)) %>% 
      addTiles() %>% # Add default OpenStreetMap map tiles
      addProviderTiles("Esri.WorldImagery") %>%
      addMarkers(data = x, lat = ~Y, lng = ~X, layerId = ~OBJECTID) 
      })
  

  
  # show image
    # fire_chosen <- reactive({input$fires})
    # output$dbr_plot <- renderPlot(rasterList$`fire_chosen`)
    # #renderImage()
    # output$dbr_map <- renderLeaflet({
    #   leaflet() %>% 
    #     addTiles %>% 
    #     addRasterImage(fire_chosen()) 
    # })
  
  # define legend inputs for DBR maps
  colorsDBR = c("darkgreen", "forestgreen", "limegreen", "yellow", "orange", "orangered", "purple")
  binsDBR = c(-1000, -251, -101, 99, 269, 439, 659, 2000)
  paletteDBR <- colorBin(palette = colorsDBR, bins = binsDBR, domain = binsDBR, na.color = "transparent")
  labelsDBR = c("Enhanced Regrowth, High", "Enhanced Regrowth, Low", "Unburned", "Low Severity", "Modereat-Low Severity", "Moderate-High Severity", "High Severity")

 
    observeEvent(input$map_marker_click, {
      # user clicks fire
      click <- input$map_marker_click
    
      # DBR map
      fire_chosen <- reactive({rasterList[[click$id]]})
      
      output$dbr_map <- renderLeaflet({
      leaflet() %>% 
        addTiles %>% 
        addProviderTiles("Esri.WorldImagery") %>%
        addRasterImage(fire_chosen(), colors = paletteDBR, opacity = 0.8) %>%
        addLegend(position = "bottomleft",
                  pal = paletteDBR,
                  values = binsDBR,
                  opacity = 0.7,
                  title = "dNBR Classes",
                  labFormat = function(type, cuts, p) {
                    paste0(labelsDBR)
                  }
        )
      })
      
      # Live Biomass Map
      # live biomass raster for selected fire
      livebiomass_fire <- reactive({live_biomassList[[click$id]]})
       
      # define legend inputs for live biomass maps
      domainLB <- cellStats(livebiomass_fire(), "range")
      paletteLB <- colorNumeric("Greens", domain = domainLB, na.color = "transparent")
  

      output$livebiomass_map <- renderLeaflet({
      leaflet() %>% 
        addTiles %>% 
        addProviderTiles("Esri.WorldImagery") %>%
        addRasterImage(livebiomass_fire(), colors = paletteLB, opacity = 1) %>%
        addLegend(position = "bottomleft",
                  pal = paletteLB,
                  values = domainLB, 
                  opacity = 0.7,
                  title = "live biomass (kg/ha)")
      })
      
     #  # Dead Biomass Map
     #  # dead biomass raster for selected fire
     #  deadbiomass_fire <- reactive({dead_biomassList[[click$id]]})
     #   
     #  # define legend inputs for live biomass maps
     #  domainDB <- cellStats(deadbiomass_fire(), "range")
     #  paletteDB <- colorNumeric("BrBG", domain = domainDB, na.color = "transparent")
     # 
     # 
     #  output$deadbiomass_map <- renderLeaflet({
     #  leaflet() %>% 
     #    addTiles %>% 
     #    addProviderTiles("Esri.WorldImagery") %>%
     #    addRasterImage(deadbiomass_fire(), colors = paletteDB, opacity = 1) %>%
     #    addLegend(position = "bottomleft",
     #              pal = paletteDB,
     #              values = domainDB, 
     #              opacity = 0.7,
     #              title = "dead biomass (kg/ha)")
     #  })
     # 
     #  
     #  
      # Summary Table
      # create table for average weather data for each fire
        output$table <- DT::renderDT({
          ave_data %>%
            filter(FIREID == click$id) %>%
            dplyr::select(month_temp, week_temp, month_precip, week_precip,
                          wind_speed, wind_max, month_humid, week_humid)
        })

        })
 
  
}


```

# Run Shiny
```{r}
shinyApp(ui = ui, server = server)


```